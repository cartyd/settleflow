{% extends "layout.njk" %}
{% import "macros.njk" as macros %}

{% block title %}{{ pageTitle | escape }}{% endblock %}

{# Override header to prevent empty h1 #}
{% block header %}{% endblock %}

{% block content %}
<div class="detail-header">
    <a href="{{ (config.listViewPath or '/admin/batches') | escape }}" class="back-link">{{ (config.actionLabels and config.actionLabels.backToBatches) or '← Back to Batches' }}</a>
    <h1>{{ config.headingPrefix | escape }} {{ macros.safeValue(batch.nvlPaymentRef) }}</h1>
    <div class="detail-header-info">
        <span>
            <strong>{{ config.agencyLabel | escape }}:</strong>
            {{ macros.safeValue(batch.agencyName) }}
        </span>
        <span>
            <strong>{{ config.statusLabel | escape }}:</strong>
            {{ macros.statusBadge(batch.status, statusClasses) }}
        </span>
        <span>
            <strong>Week:</strong>
            {{ batch.weekStartDate | date('MMM D') }} - {{ batch.weekEndDate | date('MMM D, YYYY') }}
        </span>
    </div>
</div>

{# Document Info Card #}
<div class="document-info-card">
    <div class="document-info-header">
        <h3>Document Information</h3>
        <button type="button" class="btn-secondary" onclick="resetAndReparseImportFile('{{ batch.importFileId }}')" title="Reset parsing status and re-parse the document">Reset & Re-parse</button>
    </div>
    <div class="document-meta">
        <div class="meta-item">
            <span class="meta-label">File:</span>
            <span class="meta-value">{{ batch.fileName }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Size:</span>
            <span class="meta-value">{{ (batch.fileSize / 1024) | round(1) }} KB</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Pages:</span>
            <span class="meta-value">{{ batch.pageCount }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Uploaded:</span>
            <span class="meta-value">{{ batch.uploadedAt | date('MMM D, YYYY h:mm A') }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Last Parsed:</span>
            <span class="meta-value">{{ batch.lastParsedAt | date('MMM D, YYYY h:mm A') if batch.lastParsedAt else 'Not parsed' }}</span>
        </div>
    </div>
    {% if batch.parseErrors and batch.parseErrors.length > 0 %}
        <div class="parse-errors-alert">
            <strong>⚠️ Parse Errors:</strong>
            <ul>
                {% for error in batch.parseErrors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>

{# Financial Summary - Enhanced with 4 metrics #}
<div class="financial-summary">
    <h2>Financial Summary</h2>
    <div class="info-grid info-grid-4">
        {{ macros.infoCard(
            'Total Revenue',
            macros.formatCurrency(batch.totalRevenue, '$', 2)
        ) }}
        {{ macros.infoCard(
            'Total Advances',
            macros.formatCurrency(batch.totalAdvances, '$', 2)
        ) }}
        {{ macros.infoCard(
            'Total Deductions',
            macros.formatCurrency(batch.totalDeductions, '$', 2)
        ) }}
        {{ macros.infoCard(
            'Net Payment',
            macros.formatCurrency(batch.netTotal, '$', 2)
        ) }}
    </div>
</div>

{# Batch Breakdown Table - Grouped by Category #}
<section class="batch-breakdown" aria-labelledby="breakdown-heading">
    <h2 id="breakdown-heading">Batch Line Items</h2>
    
    {# Revenue Distribution Lines #}
    {% if batch.lineItems.revenueDistribution and batch.lineItems.revenueDistribution.length > 0 %}
        <details class="breakdown-category" open>
            <summary>
                <span class="category-title">Revenue Distribution</span>
                <span class="category-count">{{ batch.lineItems.revenueDistribution.length }} items</span>
            </summary>
            <div class="breakdown-table-container">
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Trip #</th>
                            <th>Description</th>
                            <th>Driver</th>
                            <th>RDD</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in batch.lineItems.revenueDistribution %}
                            {% set shipper = line.shipperName or 'Unknown' %}
                            {% set origin = line.origin or 'Unknown' %}
                            {% set destination = line.destination or 'Unknown' %}
                            {% set driverLast = line.driverLastName or line.driverName or '-' %}
                            {% set driverFirst = line.driverFirstName or '' %}
                            {% set deliveryDate = line.deliveryDate or '-' %}
                            <tr>
                                <td><a href="#page-{{ line.pageNumber }}" class="page-link">{{ line.pageNumber }}</a></td>
                                <td>{{ line.tripNumber or '-' }}</td>
                                <td>{{ shipper }}: {{ origin }} → {{ destination }}</td>
                                <td>{{ driverLast }}{{ (', ' + driverFirst) if driverFirst else '' }}</td>
                                <td>{{ deliveryDate | date('MM/DD/YYYY') if deliveryDate != '-' else '-' }}</td>
                                <td class="amount-cell negative">${{ line.amount | abs | number(2) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    {% endif %}
    
    {# Advances #}
    {% if batch.lineItems.advances and batch.lineItems.advances.length > 0 %}
        <details class="breakdown-category">
            <summary>
                <span class="category-title">Advances</span>
                <span class="category-count">{{ batch.lineItems.advances.length }} items</span>
            </summary>
            <div class="breakdown-table-container">
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in batch.lineItems.advances %}
                            <tr>
                                <td><a href="#page-{{ line.pageNumber }}" class="page-link">{{ line.pageNumber }}</a></td>
                                <td>{{ line.description }}</td>
                                <td>{{ line.date | date('MMM D, YYYY') if line.date else '-' }}</td>
                                <td>{{ line.reference or '-' }}</td>
                                <td class="amount-cell positive">${{ line.amount | abs | number(2) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    {% endif %}
    
    {# Credit/Debit (Deductions) #}
    {% if batch.lineItems.creditDebit and batch.lineItems.creditDebit.length > 0 %}
        <details class="breakdown-category">
            <summary>
                <span class="category-title">Deductions (Credit/Debit)</span>
                <span class="category-count">{{ batch.lineItems.creditDebit.length }} items</span>
            </summary>
            <div class="breakdown-table-container">
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in batch.lineItems.creditDebit %}
                            <tr>
                                <td><a href="#page-{{ line.pageNumber }}" class="page-link">{{ line.pageNumber }}</a></td>
                                <td>{{ line.description }}</td>
                                <td>{{ line.date | date('MMM D, YYYY') if line.date else '-' }}</td>
                                <td class="amount-cell positive">${{ line.amount | abs | number(2) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    {% endif %}
    
    {# Posting Ticket #}
    {% if batch.lineItems.postingTicket and batch.lineItems.postingTicket.length > 0 %}
        <details class="breakdown-category">
            <summary>
                <span class="category-title">Posting Ticket</span>
                <span class="category-count">{{ batch.lineItems.postingTicket.length }} items</span>
            </summary>
            <div class="breakdown-table-container">
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Description</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in batch.lineItems.postingTicket %}
                            <tr>
                                <td><a href="#page-{{ line.pageNumber }}" class="page-link">{{ line.pageNumber }}</a></td>
                                <td>{{ line.description }}</td>
                                <td class="amount-cell positive">${{ line.amount | abs | number(2) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
{% endif %}
</section>

{# PDF Viewer Section #}
<section class="pdf-viewer-section" aria-labelledby="pdf-viewer-heading">
    <h2 id="pdf-viewer-heading">Settlement Document</h2>
    <div id="pdf-viewer-container" class="pdf-viewer-container">
        <div class="pdf-toolbar">
            <span id="current-page-display">Page 1 of {{ batch.pageCount }}</span>
            <div class="pdf-controls">
                <button type="button" onclick="navigatePdfPage('prev')" class="pdf-nav-btn" title="Previous Page">← Prev</button>
                <button type="button" onclick="navigatePdfPage('next')" class="pdf-nav-btn" title="Next Page">Next →</button>
            </div>
        </div>
        <iframe 
            id="pdf-viewer" 
            src="/admin/batches/{{ batch.id }}/pdf?page=1" 
            class="pdf-iframe"
            title="Settlement Document PDF">
        </iframe>
    </div>
</section>

{# Trip Details Section #}
{% if batch.trips and batch.trips.length > 0 %}
<section class="trip-details" aria-labelledby="trips-heading">
    <h2 id="trips-heading">Trip Details ({{ batch.trips.length }})</h2>
    
    <div class="trips-grid">
        {% for trip in batch.trips %}
            <div class="trip-card" id="trip-{{ trip.tripNumber }}">
                <div class="trip-header">
                    <div class="trip-title">
                        <h3>Trip #{{ trip.tripNumber }}</h3>
                        <span class="trip-bl">B/L: {{ trip.billOfLading }}</span>
                    </div>
                    <a href="#page-{{ trip.pageNumber }}" class="page-link">Page {{ trip.pageNumber }}</a>
                </div>
                
                <div class="trip-info">
                    <div class="trip-info-row">
                        <strong>Driver:</strong>
                        <span>{{ trip.driverName }}</span>
                    </div>
                    {% if trip.shipperName %}
                        <div class="trip-info-row">
                            <strong>Shipper:</strong>
                            <span>{{ trip.shipperName }}</span>
                        </div>
                    {% endif %}
                    {% if trip.origin or trip.destination %}
                        <div class="trip-info-row">
                            <strong>Route:</strong>
                            <span>{{ trip.origin or 'Unknown' }} → {{ trip.destination or 'Unknown' }}</span>
                        </div>
                    {% endif %}
                    {% if trip.deliveryDate %}
                        <div class="trip-info-row">
                            <strong>Delivery Date:</strong>
                            <span>{{ trip.deliveryDate }}</span>
                        </div>
                    {% endif %}
                    <div class="trip-info-row">
                        {% if trip.weight %}
                            <span><strong>Weight:</strong> {{ trip.weight }}</span>
                        {% endif %}
                        {% if trip.miles %}
                            <span><strong>Miles:</strong> {{ trip.miles }}</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if trip.serviceItems and trip.serviceItems.length > 0 %}
                    <div class="trip-services">
                        <h4>Service Items</h4>
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Revenue/Expense</th>
                                    <th>% Due</th>
                                    <th>Charges</th>
                                    <th>Earnings</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in trip.serviceItems %}
                                    <tr>
                                        <td>{{ item.description }}</td>
                                        <td>{{ item.revenueExpense or '-' }}</td>
                                        <td>{{ item.percentageDue or '-' }}</td>
                                        <td>{{ macros.formatCurrency(item.charges, '$', 2) if item.charges else '-' }}</td>
                                        <td>{{ macros.formatCurrency(item.earnings, '$', 2) if item.earnings else '-' }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                
                <div class="trip-total">
                    <strong>Net Balance:</strong>
                    <span class="trip-net-balance">${{ trip.netBalance | number(2) }}</span>
                </div>
            </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section aria-labelledby="import-files-heading">
    <div class="section-header">
        <h2 id="import-files-heading" class="section-heading">Raw Document Data (Advanced)</h2>
        <button type="button" class="btn-secondary" onclick="document.getElementById('raw-data-section').style.display = document.getElementById('raw-data-section').style.display === 'none' ? 'block' : 'none'">Toggle Raw Data</button>
    </div>

    <div id="raw-data-section" style="display: none;">
        <p class="section-description">This section shows raw parsing data and debugging information.</p>
        <div class="empty-state">
            <p>Raw document data is available via API endpoint:</p>
            <code>GET /api/batches/{{ batch.id }}/details</code>
        </div>
    </div>
</section>

<script>
// Reset and re-parse import file
window.resetAndReparseImportFile = function(importFileId) {
    if (!importFileId) {
        alert('Import file ID not found');
        return;
    }
    
    if (!confirm('This will clear all parsed data and re-parse the document. Continue?')) {
        return;
    }
    
    const resetBtn = event.target;
    resetBtn.disabled = true;
    resetBtn.textContent = 'Resetting...';
    
    // Step 1: Reset the import file
    fetch(`http://localhost:3000/batches/import-files/${importFileId}/reset`, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error('Reset failed');
        return response.json();
    })
    .then(() => {
        resetBtn.textContent = 'Re-parsing...';
        // Step 2: Re-parse the import file
        return fetch(`http://localhost:3000/batches/import-files/${importFileId}/parse`, {
            method: 'POST'
        });
    })
    .then(response => {
        if (!response.ok) throw new Error('Re-parse failed');
        return response.json();
    })
    .then(() => {
        alert('Re-parsing complete! Reloading page...');
        window.location.reload();
    })
    .catch(error => {
        resetBtn.disabled = false;
        resetBtn.textContent = 'Reset & Re-parse';
        alert('Error: ' + error.message);
        console.error('Reset/re-parse error:', error);
    });
};

// PDF Viewer Navigation
(function() {
    const batchId = '{{ batch.id }}';
    const totalPages = {{ batch.pageCount }};
    let currentPage = 1;
    
    // Update current page display
    function updatePageDisplay(pageNum) {
        currentPage = pageNum;
        const display = document.getElementById('current-page-display');
        if (display) {
            display.textContent = `Page ${pageNum} of ${totalPages}`;
        }
    }
    
    // Navigate to specific PDF page
    window.showPdfPage = function(pageNumber) {
        const viewer = document.getElementById('pdf-viewer');
        const container = document.getElementById('pdf-viewer-container');
        
        if (viewer && container) {
            // Update iframe src with page query parameter
            viewer.src = `/admin/batches/${batchId}/pdf?page=${pageNumber}`;
            
            // Scroll to PDF viewer
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Update page display
            updatePageDisplay(pageNumber);
        }
    };
    
    // Navigate prev/next
    window.navigatePdfPage = function(direction) {
        let newPage = currentPage;
        
        if (direction === 'prev' && currentPage > 1) {
            newPage = currentPage - 1;
        } else if (direction === 'next' && currentPage < totalPages) {
            newPage = currentPage + 1;
        }
        
        if (newPage !== currentPage) {
            showPdfPage(newPage);
        }
    };
    
    // Handle page link clicks
    document.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageNumber = parseInt(link.getAttribute('href').replace('#page-', ''));
            showPdfPage(pageNumber);
        });
    });
    
    // Try to extract page number from PDF viewer on load (doesn't always work due to cross-origin)
    const viewer = document.getElementById('pdf-viewer');
    if (viewer) {
        viewer.addEventListener('load', function() {
            // Update display to page 1 initially
            updatePageDisplay(1);
        });
    }
})();
</script>
{% endblock %}
